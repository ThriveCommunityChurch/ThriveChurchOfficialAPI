name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - dev
      - master

# Required permissions for posting PR review comments
permissions:
  contents: read
  pull-requests: write

env:
  # Maximum number of changed lines before skipping detailed review
  MAX_DIFF_LINES: 750

  # ============================================
  # OpenAI Configuration
  # ============================================
  # Set to 'true' to use Azure OpenAI, 'false' for OpenAI directly
  USE_AZURE_OPENAI: 'true'

  # Standard OpenAI settings (used when USE_AZURE_OPENAI=false)
  # Requires secret: OPENAI_API_KEY
  OPENAI_MODEL: gpt-4o-mini

  # Azure OpenAI settings (used when USE_AZURE_OPENAI=true)
  # Requires secrets: AZURE_OPENAI_API_KEY, AZURE_OPENAI_ENDPOINT, AZURE_OPENAI_DEPLOYMENT
  # AZURE_OPENAI_API_VERSION: '2024-08-01-preview'  # Uncomment to override default

  # TODO: Future enhancement - implement model ramping based on diff size

jobs:
  review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # Don't run on draft PRs or PRs from forks (security)
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diffs

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install openai requests

      - name: Run AI Code Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_FULL_NAME: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          MAX_DIFF_LINES: ${{ env.MAX_DIFF_LINES }}
          # OpenAI or Azure OpenAI toggle
          USE_AZURE_OPENAI: ${{ env.USE_AZURE_OPENAI }}
          # Standard OpenAI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ env.OPENAI_MODEL }}
          # Azure OpenAI
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
        run: python .github/scripts/ai_code_review.py

